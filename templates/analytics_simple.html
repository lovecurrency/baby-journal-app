{% extends "base.html" %}

{% block title %}Feeding Analytics - Baby Activity Journal{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container {
        background: white;
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }

    .chart-wrapper {
        position: relative;
        height: 400px;
        width: 100%;
    }

    .metric-card {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h2><i class="bi bi-cup-straw"></i> Feeding Analytics</h2>
    <p class="text-muted">Track feeding patterns and quantities</p>
</div>

{% if error %}
<div class="alert alert-warning text-center">
    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
    <h5 class="mt-3">{{ error }}</h5>
    <a href="{{ url_for('quick_add') }}" class="btn btn-primary mt-2">Add feeding activity</a>
</div>
{% else %}

<!-- Feeding Metrics -->
{% if metrics %}
<div class="row mb-4">
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-value">{{ metrics.daily_avg_feed }}ml</div>
            <div class="metric-label">Daily Avg Quantity</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-value">{{ metrics.frequency }}</div>
            <div class="metric-label">Frequency (feeds/day)</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-value">{{ metrics.days_tracked }}</div>
            <div class="metric-label">Days Tracked</div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-value">{{ metrics.avg_amount }}ml</div>
            <div class="metric-label">Avg Quantity</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-value">{{ metrics.weekly_avg_feed }}ml</div>
            <div class="metric-label">Weekly Avg Quantity</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-value">{{ metrics.breast_feed_percentage }}%</div>
            <div class="metric-label">Breast Feed %</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Feeding Chart -->
<div class="chart-container">
    <h4><i class="bi bi-graph-up"></i> Daily Feeding Quantities</h4>
    <div class="chart-wrapper">
        <canvas id="feedingChart"></canvas>
    </div>
</div>

<!-- Recent Feeding List -->
<div class="chart-container">
    <h4><i class="bi bi-list-ul"></i> Recent Feeding Activities</h4>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Quantity</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for feed in feeding_data[-10:]|reverse %}
                <tr>
                    <td>{{ feed.date }}</td>
                    <td>{{ feed.time }}</td>
                    <td>
                        {% if feed.amount > 0 %}
                            <span class="badge bg-primary">{{ feed.amount }}ml</span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{{ feed.description }}</td>
                    <td>
                        {% if feed.feeding_type == 'breast' %}
                            <span class="badge bg-success">Breast</span>
                        {% elif feed.feeding_type == 'bottle' %}
                            <span class="badge bg-info">Bottle</span>
                        {% elif feed.feeding_type == 'formula' %}
                            <span class="badge bg-warning">Formula</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ feed.feeding_type|title }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('edit_activity', activity_id=feed.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Prepare chart data
const feedingData = {{ feeding_data|tojson }};
console.log('Feeding data:', feedingData);

// Validate data
if (!feedingData || feedingData.length === 0) {
    console.warn('No feeding data available for chart');
    document.getElementById('feedingChart').parentElement.innerHTML =
        '<div class="text-center text-muted p-4"><i class="bi bi-info-circle"></i> No feeding data available for chart</div>';
} else {
    // Group by date and sum amounts
    const dailyTotals = {};
    feedingData.forEach(feed => {
        if (feed.date) {
            // Convert amount to number if it's a string
            let amount = 0;
            if (feed.amount !== null && feed.amount !== undefined) {
                amount = typeof feed.amount === 'number' ? feed.amount : parseFloat(feed.amount) || 0;
            }

            if (!dailyTotals[feed.date]) {
                dailyTotals[feed.date] = 0;
            }
            dailyTotals[feed.date] += amount;
        }
    });

    console.log('Daily totals:', dailyTotals);

    // Prepare chart labels and data
    const labels = Object.keys(dailyTotals).sort();
    const data = labels.map(date => dailyTotals[date]);

    console.log('Chart labels:', labels);
    console.log('Chart data:', data);

    // Only create chart if we have valid data (allow zero values for days with no feeding)
    if (labels.length > 0) {
        // Create chart
        const ctx = document.getElementById('feedingChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Daily Feeding Quantity (ml)',
                    data: data,
                    borderColor: '#74b9ff',
                    backgroundColor: 'rgba(116, 185, 255, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#74b9ff',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.y}ml`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantity (ml)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + 'ml';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('feedingChart').parentElement.innerHTML =
            '<div class="text-center text-muted p-4"><i class="bi bi-info-circle"></i> No valid feeding quantities found for chart</div>';
    }
}
</script>

{% endif %}
{% endblock %}