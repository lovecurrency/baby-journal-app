{% extends "base.html" %}

{% block title %}Feeding Analytics - Baby Activity Journal{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container {
        background: white;
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }

    .metric-card {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h2><i class="bi bi-cup-straw"></i> Feeding Analytics</h2>
    <p class="text-muted">Track feeding patterns and amounts</p>
</div>

{% if error %}
<div class="alert alert-warning text-center">
    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
    <h5 class="mt-3">{{ error }}</h5>
    <a href="{{ url_for('quick_add') }}" class="btn btn-primary mt-2">Add Feeding Activity</a>
</div>
{% else %}

<!-- Feeding Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value">{{ feeding_data|length }}</div>
            <div class="metric-label">Total Feeds</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value">
                {% set total_amount = feeding_data|selectattr('amount')|map(attribute='amount')|sum %}
                {{ total_amount|round(1) }}ml
            </div>
            <div class="metric-label">Total Amount</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value">
                {% set amounts = feeding_data|selectattr('amount')|map(attribute='amount')|list %}
                {% if amounts %}
                    {{ (amounts|sum / amounts|length)|round(1) }}ml
                {% else %}
                    0ml
                {% endif %}
            </div>
            <div class="metric-label">Average Amount</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value">
                {% set dates = feeding_data|map(attribute='date')|unique|list %}
                {{ dates|length }}
            </div>
            <div class="metric-label">Days Tracked</div>
        </div>
    </div>
</div>

<!-- Feeding Chart -->
<div class="chart-container">
    <h4><i class="bi bi-graph-up"></i> Daily Feeding Amounts</h4>
    <canvas id="feedingChart" height="100"></canvas>
</div>

<!-- Recent Feeding List -->
<div class="chart-container">
    <h4><i class="bi bi-list-ul"></i> Recent Feeding Activities</h4>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Amount</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                {% for feed in feeding_data[-10:] %}
                <tr>
                    <td>{{ feed.date }}</td>
                    <td>{{ feed.time }}</td>
                    <td>
                        {% if feed.amount > 0 %}
                            <span class="badge bg-primary">{{ feed.amount }}ml</span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{{ feed.description }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Prepare chart data
const feedingData = {{ feeding_data|tojson }};

// Group by date and sum amounts
const dailyTotals = {};
feedingData.forEach(feed => {
    if (!dailyTotals[feed.date]) {
        dailyTotals[feed.date] = 0;
    }
    dailyTotals[feed.date] += feed.amount || 0;
});

// Prepare chart labels and data
const labels = Object.keys(dailyTotals).sort();
const data = labels.map(date => dailyTotals[date]);

// Create chart
const ctx = document.getElementById('feedingChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Daily Feeding Amount (ml)',
            data: data,
            borderColor: '#74b9ff',
            backgroundColor: 'rgba(116, 185, 255, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#74b9ff',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Amount (ml)'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Date'
                }
            }
        }
    }
});
</script>

{% endif %}
{% endblock %}